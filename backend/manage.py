#!/usr/bin/env python
"""
FELICITA - Django Management Script
Sistema de Facturaci√≥n Electr√≥nica para Per√∫

Django's command-line utility for administrative tasks.
"""

import os
import sys
import logging
from decouple import config

def main():
    """Run administrative tasks."""
    
    # Configurar logging b√°sico
    logging.basicConfig(
        level=logging.INFO,
        format='%(asctime)s [%(levelname)s] %(name)s: %(message)s'
    )
    
    logger = logging.getLogger('felicita.manage')
    
    # ===========================================
    # CONFIGURACI√ìN DEL AMBIENTE
    # ===========================================
    
    # Determinar el ambiente
    environment = config('ENVIRONMENT', default='local').lower()
    
    # Configurar Django settings module seg√∫n el ambiente
    if environment in ['production', 'prod', 'staging']:
        settings_module = 'config.settings.produccion'
    elif environment in ['testing', 'test']:
        settings_module = 'config.settings.testing'
    else:
        settings_module = 'config.settings.local'
    
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', settings_module)
    
    logger.info(f"üîß FELICITA Management - Ambiente: {environment.upper()}")
    logger.info(f"‚öôÔ∏è  Settings module: {settings_module}")
    
    # ===========================================
    # VALIDACIONES PRE-EJECUCI√ìN
    # ===========================================
    
    def validate_environment():
        """Validar que el ambiente est√© correctamente configurado"""
        try:
            # Verificar que Django est√© instalado
            try:
                import django
                logger.info(f"‚úÖ Django {django.get_version()} detectado")
            except ImportError as exc:
                logger.error("‚ùå Django no est√° instalado o no est√° disponible en el PYTHONPATH.")
                logger.error(f"Error: {exc}")
                sys.exit(1)
            
            # Verificar archivo .env en desarrollo
            if environment in ['local', 'development']:
                env_file = os.path.join(os.path.dirname(os.path.dirname(__file__)), '.env')
                if not os.path.exists(env_file):
                    logger.warning("‚ö†Ô∏è  Archivo .env no encontrado. Usando valores por defecto.")
                else:
                    logger.info("‚úÖ Archivo .env encontrado")
            
            # Verificar variables cr√≠ticas en producci√≥n
            if environment in ['production', 'prod', 'staging']:
                required_vars = [
                    'SECRET_KEY',
                    'DB_PRODUCCION_NOMBRE',
                    'DB_PRODUCCION_USUARIO',
                    'DB_PRODUCCION_PASSWORD',
                ]
                
                missing_vars = []
                for var in required_vars:
                    if not config(var, default=None):
                        missing_vars.append(var)
                
                if missing_vars:
                    logger.error(f"‚ùå Variables de entorno faltantes en producci√≥n: {missing_vars}")
                    sys.exit(1)
                else:
                    logger.info("‚úÖ Variables de entorno de producci√≥n verificadas")
            
            return True
            
        except Exception as e:
            logger.error(f"‚ùå Error en validaci√≥n del ambiente: {e}")
            return False
    
    # Validar ambiente
    if not validate_environment():
        sys.exit(1)
    
    # ===========================================
    # COMANDOS PERSONALIZADOS
    # ===========================================
    
    def handle_custom_commands():
        """Manejar comandos personalizados de FELICITA"""
        if len(sys.argv) > 1:
            command = sys.argv[1]
            
            # Comando para inicializar datos
            if command == 'init_felicita':
                logger.info("üöÄ Inicializando FELICITA...")
                
                # Secuencia de comandos para inicializaci√≥n
                commands = [
                    ['makemigrations'],
                    ['migrate'],
                    ['collectstatic', '--noinput'],
                    ['loaddata', 'fixtures/datos_iniciales.json'],
                ]
                
                for cmd in commands:
                    logger.info(f"Ejecutando: python manage.py {' '.join(cmd)}")
                    try:
                        from django.core.management import execute_from_command_line
                        execute_from_command_line(['manage.py'] + cmd)
                    except Exception as e:
                        logger.error(f"‚ùå Error ejecutando {cmd}: {e}")
                        sys.exit(1)
                
                logger.info("‚úÖ FELICITA inicializado correctamente")
                sys.exit(0)
            
            # Comando para cargar datos de ejemplo
            elif command == 'load_sample_data':
                logger.info("üìä Cargando datos de ejemplo...")
                
                fixtures = [
                    'fixtures/usuarios_iniciales.json',
                    'fixtures/plan_cuentas_pcge.json',
                    'fixtures/productos_ejemplo.json',
                    'fixtures/clientes_ejemplo.json',
                    'fixtures/series_comprobantes.json',
                ]
                
                for fixture in fixtures:
                    if os.path.exists(fixture):
                        logger.info(f"Cargando: {fixture}")
                        try:
                            from django.core.management import execute_from_command_line
                            execute_from_command_line(['manage.py', 'loaddata', fixture])
                        except Exception as e:
                            logger.warning(f"‚ö†Ô∏è  Error cargando {fixture}: {e}")
                    else:
                        logger.warning(f"‚ö†Ô∏è  Fixture no encontrado: {fixture}")
                
                logger.info("‚úÖ Datos de ejemplo cargados")
                sys.exit(0)
            
            # Comando para reset completo (solo desarrollo)
            elif command == 'reset_dev':
                if environment not in ['local', 'development']:
                    logger.error("‚ùå El comando reset_dev solo est√° disponible en desarrollo")
                    sys.exit(1)
                
                logger.warning("‚ö†Ô∏è  RESET COMPLETO - Se eliminar√°n todos los datos")
                
                import time
                logger.info("Esperando 5 segundos... (Ctrl+C para cancelar)")
                time.sleep(5)
                
                commands = [
                    ['flush', '--noinput'],
                    ['migrate'],
                    ['createsuperuser', '--noinput', '--username=admin', '--email=admin@felicita.pe'],
                    ['loaddata', 'fixtures/datos_iniciales.json'],
                ]
                
                for cmd in commands:
                    try:
                        from django.core.management import execute_from_command_line
                        execute_from_command_line(['manage.py'] + cmd)
                    except Exception as e:
                        logger.warning(f"‚ö†Ô∏è  Error en {cmd}: {e}")
                
                logger.info("üîÑ Reset de desarrollo completado")
                sys.exit(0)
            
            # Mostrar ayuda personalizada
            elif command == 'help_felicita':
                print("\nüáµüá™ FELICITA - Comandos Personalizados:")
                print("  init_felicita        - Inicializar sistema completo")
                print("  load_sample_data     - Cargar datos de ejemplo")
                print("  reset_dev           - Reset completo (solo desarrollo)")
                print("  help_felicita       - Mostrar esta ayuda")
                print("\nüìò Comandos Django est√°ndar tambi√©n disponibles:")
                print("  runserver           - Iniciar servidor de desarrollo")
                print("  shell              - Abrir shell de Django")
                print("  makemigrations     - Crear migraciones")
                print("  migrate            - Aplicar migraciones")
                print("  collectstatic      - Recolectar archivos est√°ticos")
                print("  createsuperuser    - Crear superusuario")
                print("  test               - Ejecutar tests")
                print()
                sys.exit(0)
    
    # Manejar comandos personalizados
    handle_custom_commands()
    
    # ===========================================
    # EJECUCI√ìN PRINCIPAL
    # ===========================================
    
    try:
        from django.core.management import execute_from_command_line
        
        # Log del comando ejecutado (excepto runserver para evitar spam)
        if len(sys.argv) > 1 and sys.argv[1] != 'runserver':
            logger.info(f"üîß Ejecutando comando: {' '.join(sys.argv[1:])}")
        
        # Ejecutar comando Django
        execute_from_command_line(sys.argv)
        
    except ImportError as exc:
        logger.error("‚ùå No se pudo importar Django.")
        logger.error("¬øEst√° instalado y disponible en tu variable PYTHONPATH?")
        logger.error("¬øOlvidaste activar el virtual environment?")
        logger.error(f"Error espec√≠fico: {exc}")
        sys.exit(1)
        
    except KeyboardInterrupt:
        logger.info("\n‚ö° Comando interrumpido por el usuario")
        sys.exit(0)
        
    except Exception as e:
        logger.error(f"‚ùå Error ejecutando comando: {e}")
        sys.exit(1)

# ===========================================
# INFORMACI√ìN DEL SISTEMA
# ===========================================

def show_system_info():
    """Mostrar informaci√≥n del sistema"""
    if '--info' in sys.argv:
        import platform
        import django
        
        print("\nüîç INFORMACI√ìN DEL SISTEMA FELICITA:")
        print(f"  üêç Python: {platform.python_version()}")
        
        try:
            print(f"  üîß Django: {django.get_version()}")
        except:
            print("  üîß Django: No instalado")
        
        print(f"  üíª Sistema: {platform.system()} {platform.release()}")
        print(f"  üèóÔ∏è  Arquitectura: {platform.architecture()[0]}")
        print(f"  üìÅ Directorio: {os.getcwd()}")
        print(f"  üåç Ambiente: {config('ENVIRONMENT', default='local').upper()}")
        print()
        sys.exit(0)

# Mostrar informaci√≥n si se solicita
show_system_info()

# ===========================================
# BANNER FELICITA
# ===========================================

def show_banner():
    """Mostrar banner de FELICITA"""
    if len(sys.argv) > 1 and sys.argv[1] == 'runserver':
        print("\n" + "="*60)
        print("üáµüá™ FELICITA - Sistema de Facturaci√≥n Electr√≥nica para Per√∫")
        print("="*60)
        print(f"üåç Ambiente: {config('ENVIRONMENT', default='local').upper()}")
        print("üöÄ Iniciando servidor de desarrollo...")
        print("üì± Admin: http://localhost:8000/admin/")
        print("üìñ API Docs: http://localhost:8000/api/docs/")
        print("="*60 + "\n")

# Mostrar banner para runserver
show_banner()

# ===========================================
# PUNTO DE ENTRADA
# ===========================================

if __name__ == '__main__':
    main()